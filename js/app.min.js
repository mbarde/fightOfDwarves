var game={music_volume:.3,data:{initHealth:100,playerCount:4,health:[]},constants:{attack_power:10,attack_push_power:60,attack_push_power_block:60,flicker_time:100,winner_time:4e3,block_burst_time:1e3,block_burst_vulnerability_threshold:400},players:[],onload:function(){return me.video.init(640,480,{wrapper:"screen",scale:"auto"})?(me.game.HASH.debug===!0&&window.onReady(function(){me.plugin.register.defer(this,me.debug.Panel,"debug",me.input.KEY.V)}),me.audio.init("mp3,ogg"),me.loader.onload=this.loaded.bind(this),me.loader.preload(game.resources),void me.state.change(me.state.LOADING)):void alert("Your browser does not support HTML5 canvas.")},loaded:function(){this.playScreen=new game.PlayScreen,me.state.set(me.state.PLAY,this.playScreen),me.state.set(me.state.MENU,new game.TitleScreen),game.data.health=[];for(var a=0;a<game.data.playerCount;a++)game.data.health.push(game.data.initHealth);me.state.change(me.state.MENU)}};game.resources=[{name:"03 Ferrous Rage",type:"audio",src:"data/sfx/"},{name:"attack01",type:"audio",src:"data/sfx/"},{name:"attack02",type:"audio",src:"data/sfx/"},{name:"attack03",type:"audio",src:"data/sfx/"},{name:"dead01",type:"audio",src:"data/sfx/"},{name:"hit01",type:"audio",src:"data/sfx/"},{name:"jump01",type:"audio",src:"data/sfx/"},{name:"menu",type:"audio",src:"data/sfx/"},{name:"32x32_font",type:"image",src:"data/img/font/32x32_font.png"},{name:"title_screen",type:"image",src:"data/img/gui/title_screen.png"},{name:"castle_tileset_part1_0",type:"image",src:"data/img/map/castle_tileset_part1_0.png"},{name:"castle_tileset_part2",type:"image",src:"data/img/map/castle_tileset_part2.png"},{name:"castle_tileset_part3",type:"image",src:"data/img/map/castle_tileset_part3.png"},{name:"dwarf_blue",type:"image",src:"data/img/sprite/dwarf_blue.png"},{name:"dwarf_brown",type:"image",src:"data/img/sprite/dwarf_brown.png"},{name:"dwarf_green",type:"image",src:"data/img/sprite/dwarf_green.png"},{name:"dwarf_red",type:"image",src:"data/img/sprite/dwarf_red.png"},{name:"dwarves",type:"image",src:"data/img/sprite/dwarves.png"},{name:"area01",type:"tmx",src:"data/map/area01.tmx"},{name:"area02",type:"tmx",src:"data/map/area02.tmx"},{name:"area03",type:"tmx",src:"data/map/area03.tmx"},{name:"area04",type:"tmx",src:"data/map/area04.tmx"},{name:"area05",type:"tmx",src:"data/map/area05.tmx"},{name:"area06",type:"tmx",src:"data/map/area06.tmx"},{name:"area07",type:"tmx",src:"data/map/area07.tmx"},{name:"area08",type:"tmx",src:"data/map/area08.tmx"}],game.HUD=game.HUD||{},game.HUD.Container=me.Container.extend({init:function(){me.Container.prototype.init.apply(this),this.isPersistent=!0,this.floating=!0,this.z=1/0,this.name="HUD",this.addChild(new game.HUD.HealthItem(80,440))}}),game.HUD.HealthItem=me.Renderable.extend({init:function(a,b){me.Renderable.prototype.init.apply(this,[a,b,10,10]),this.font=new me.BitmapFont("32x32_font",32),this.font.set("right"),this.health_offs=[{x:20,y:0},{x:540,y:0},{x:20,y:-430},{x:540,y:-430}],this.health=[];for(var c=0;c<game.data.playerCount;c++)this.health.push(game.initHealth)},update:function(a){made_changes=!1;for(var b=0;b<game.data.playerCount;b++)this.health[b]!==game.data.health[b]&&(this.health[b]=game.data.health[b],made_changes=!0);return made_changes},draw:function(a){for(var b=0;b<game.data.playerCount;b++)this.font.draw(a,game.data.health[b],this.pos.x+this.health_offs[b].x,this.pos.y+this.health_offs[b].y)}}),PlayerEntity=me.Entity.extend({init:function(a,b,c){me.Entity.prototype.init.apply(this,[a,b,c]),this.alwaysUpdate=!0,this.renderable.addAnimation("walk",[15,14,13,12,11,10]),this.renderable.addAnimation("attack",[9,8,7,6]),this.renderable.addAnimation("die",[4]),this.renderable.addAnimation("jump",[8]),this.renderable.addAnimation("block",[9]),this.renderable.addAnimation("stand",[16,17,18,19],200),this.reset()},reset:function(){this.body.setVelocity(3,15),this.body.dead=!1,this.body.boost_active=!1,this.body.push_power_x=0,this.body.attacking=!1,this.body.isAttacked=!1,this.body.current_attack_power=0,this.body.blocking=!1,this.body.block_burst=0,this.body.block_key_pressed=!1,this.renderable.setCurrentAnimation("jump")},update:function(a){var b=game.players[this.playerid-1];if(b.pos.y>540&&(game.data.health[this.playerid-1]=0),game.data.health[this.playerid-1]<=0){if(game.data.health[this.playerid-1]=0,!this.renderable.isCurrentAnimation("die")){me.audio.play("dead01");var c=this.body;this.body.dead=!0,this.body.vel.x=0,this.renderable.setCurrentAnimation("die",function(){c.dead=!0})}}else{if(this.body.block_burst>0&&(this.body.block_burst-=a),this.body.block_burst<0&&(this.body.block_burst=0),this.body.boost_active&&this.body.falling&&(this.body.boost_active=!1),me.input.isKeyPressed("left"+this.playerid)?(this.renderable.flipX(!0),this.body.vel.x-=this.body.accel.x*me.timer.tick,this.renderable.isCurrentAnimation("walk")||this.body.attacking||this.renderable.setCurrentAnimation("walk")):me.input.isKeyPressed("right"+this.playerid)?(this.renderable.flipX(!1),this.body.vel.x+=this.body.accel.x*me.timer.tick,this.renderable.isCurrentAnimation("walk")||this.body.attacking||this.renderable.setCurrentAnimation("walk")):this.body.vel.x=0,0!=this.body.push_power_x&&(this.body.vel.x+=this.body.push_power_x*me.timer.tick,this.body.push_power_x>0&&(this.body.push_power_x-=2*me.timer.tick,this.body.push_power_x<=0&&(this.body.push_power_x=0)),this.body.push_power_x<0&&(this.body.push_power_x+=2*me.timer.tick,this.body.push_power_x>=0&&(this.body.push_power_x=0))),!this.body.isAttacked&&!this.body.attacking&&me.input.isKeyPressed("attack"+this.playerid)){me.audio.play("attack02"),this.body.attacking=!0,this.body.current_attack_power=game.constants.attack_power;var c=this.body;this.renderable.setCurrentAnimation("attack",function(){c.attacking=!1,this.setCurrentAnimation("stand")})}0!=this.body.vel.x||this.body.isAttacked||this.body.attacking||this.body.jumping||this.body.falling||0!=this.body.block_burst||!me.input.isKeyPressed("block"+this.playerid)||!this.body.blocking&&this.body.block_key_pressed?this.body.blocking=!1:(this.renderable.setCurrentAnimation("block"),this.body.blocking=!0,this.body.block_key_pressed=!0),me.input.isKeyPressed("block"+this.playerid)||(this.body.block_key_pressed=!1),0==this.body.vel.y||this.renderable.isCurrentAnimation("jump")||this.body.attacking||this.renderable.setCurrentAnimation("jump"),0!=this.body.vel.y||0!=this.body.vel.x||this.renderable.isCurrentAnimation("stand")||this.body.attacking||this.body.blocking||this.renderable.setCurrentAnimation("stand"),me.input.isKeyPressed("jump"+this.playerid)&&(this.body.jumping||this.body.falling||(me.audio.play("jump01"),this.body.vel.y=-this.body.maxVel.y*me.timer.tick,this.body.jumping=!0))}return this.body.update(a),me.collision.check(this),me.Entity.prototype.update.apply(this,[a]),game.playScreen.check_for_win(),!0},onCollision:function(a,b){if(a.b.body.collisionType!==me.collision.types.WORLD_SHAPE){if(this.body.boost_active||"boost"!=a.b.type?this.body.boost_active=!1:(this.body.boost_active=!0,this.body.vel.y=3*-this.body.maxVel.y*me.timer.tick),!this.body.dead&&a.a.body.attacking&&!this.body.attacking&&!this.body.isAttacked&&a.a.body.current_attack_power>0&&this.body.block_burst<=game.constants.block_burst_vulnerability_threshold&&(a.a.renderable.lastflipX&&a.a.pos.x>=a.b.pos.x||!a.a.renderable.lastflipX&&a.a.pos.x<=a.b.pos.x))if(this.body.blocking)this.body.blocking=!1,this.body.block_burst=game.constants.block_burst_time,a.a.pos.x>a.b.pos.x?this.body.push_power_x=-game.constants.attack_push_power_block:this.body.push_power_x=game.constants.attack_push_power_block;else{this.body.isAttacked=!0,game.data.health[this.playerid-1]-=a.a.body.current_attack_power,a.a.body.current_attack_power=0,me.audio.play("hit01"),a.a.pos.x>a.b.pos.x?this.body.push_power_x=-game.constants.attack_push_power:this.body.push_power_x=game.constants.attack_push_power;var c=this.body;this.renderable.flicker(game.constants.flicker_time,function(){c.isAttacked=!1})}return!1}return this.body.boost_active&&(this.body.boost_active=!1),!0}}),game.Player1Entity=PlayerEntity.extend({init:function(a,b,c){PlayerEntity.prototype.init.apply(this,[a,b,c]),this.playerid=1}}),game.Player2Entity=PlayerEntity.extend({init:function(a,b,c){PlayerEntity.prototype.init.apply(this,[a,b,c]),this.playerid=2}}),game.Player3Entity=PlayerEntity.extend({init:function(a,b,c){PlayerEntity.prototype.init.apply(this,[a,b,c]),this.playerid=3}}),game.Player4Entity=PlayerEntity.extend({init:function(a,b,c){PlayerEntity.prototype.init.apply(this,[a,b,c]),this.playerid=4}}),game.PlayScreen=me.ScreenObject.extend({onResetEvent:function(){for(var a=game.TitleScreen.controls,b=0;b<game.data.playerCount;b++)me.input.bindKey(a[b][0],"left"+(b+1)),me.input.bindKey(a[b][1],"right"+(b+1)),me.input.bindKey(a[b][2],"jump"+(b+1),!0),me.input.bindKey(a[b][3],"attack"+(b+1),!0),me.input.bindKey(a[b][4],"block"+(b+1)),me.input.bindGamepad(b,{type:"axes",code:me.input.GAMEPAD.AXES.LX,threshold:-.5},a[b][0]),me.input.bindGamepad(b,{type:"axes",code:me.input.GAMEPAD.AXES.LX,threshold:.5},a[b][1]),me.input.bindGamepad(b,{type:"buttons",code:me.input.GAMEPAD.BUTTONS.FACE_1},a[b][2]),me.input.bindGamepad(b,{type:"buttons",code:me.input.GAMEPAD.BUTTONS.FACE_2},a[b][3]),me.input.bindGamepad(b,{type:"buttons",code:me.input.GAMEPAD.BUTTONS.FACE_3},a[b][4]),me.input.bindGamepad(b,{type:"buttons",code:me.input.GAMEPAD.BUTTONS.FACE_4},a[b][3]);me.pool.register("player1",game.Player1Entity),me.pool.register("player2",game.Player2Entity),me.pool.register("player3",game.Player3Entity),me.pool.register("player4",game.Player4Entity);var c=0;c=0==game.TitleScreen.map_selected?Math.floor(8*Math.random()+1):game.TitleScreen.map_selected,me.levelDirector.loadLevel("area0"+c),game.players=new Array(4),game.players[0]=me.game.world.getChildByName("player1")[0],game.players[1]=me.game.world.getChildByName("player2")[0],game.players[2]=me.game.world.getChildByName("player3")[0],game.players[3]=me.game.world.getChildByName("player4")[0],game.data.playerCount<4&&me.game.world.removeChild(game.players[3]),game.data.playerCount<3&&me.game.world.removeChild(game.players[2]),game.data.health=[];for(var b=0;b<game.data.playerCount;b++)game.data.health.push(game.data.initHealth);"undefined"==typeof this.HUD&&(this.HUD=new game.HUD.Container),me.game.world.hasChild(this.HUD)||me.game.world.addChild(this.HUD),game.winner_screen=!1,me.input.bindKey(me.input.KEY.ESC,"escape",!0);this.handler=me.event.subscribe(me.event.KEYDOWN,function(a,b,c){"escape"===a&&(me.audio.stopTrack(),me.state.change(me.state.MENU))})},check_for_win:function(){for(var a=0,b=-1,c=0;c<game.data.health.length;c++)game.data.health[c]<=0?a++:b=c;a!=game.data.playerCount-1||game.winner_screen||(me.audio.pauseTrack(),game.winner_screen=!0,game.win_time=(new Date).getTime(),me.game.world.addChild(new(me.Renderable.extend({init:function(){me.Renderable.prototype.init.apply(this,[0,0,me.game.viewport.width,me.game.viewport.height]),this.font=new me.BitmapFont("32x32_font",32,1),this.font_big=new me.BitmapFont("32x32_font",32,1.4)},update:function(a){var b=(new Date).getTime();return b>game.win_time+game.constants.winner_time&&(game.winner_screen=!1,me.state.change(me.state.MENU)),!0},draw:function(a){var c="PLAYER "+(b+1),d=Math.round(this.font_big.measureText(a,c).width/2);this.font_big.draw(a,c,320-d,270),c="THE NEW KING IS",d=Math.round(this.font.measureText(a,c).width/2),this.font.draw(a,c,320-d,200)},onDestroyEvent:function(){}})),9))},onDestroyEvent:function(){me.event.unsubscribe(this.handler),me.game.world.removeChild(this.HUD,!0)}}),game.TitleScreen=me.ScreenObject.extend({saveSettings:function(){},onResetEvent:function(){game.music_volume>0&&me.audio.playTrack("menu",game.music_volume+.2);var a=new me.Sprite(me.game.viewport.width/2,me.game.viewport.height/2,{image:me.loader.getImage("title_screen")});game.TitleScreen.map_selected=0,game.TitleScreen.controls=[[65,68,87,81,83],[86,66,71,70,72],[74,75,73,85,79],[37,39,38,32,40]],"undefined"==typeof game.TitleScreen.settings&&(game.TitleScreen.settings=[{text:"PLAY",values:[]},{text:"PLAYERCOUNT",values:[2,3,4],selection:2,on_change:function(a){game.data.playerCount=a.values[a.selection]}},{text:"CONTROLS 1",values:["ADWQS"],selection:0,ctrl_id:0},{text:"CONTROLS 2",values:["VBGFH"],selection:0,ctrl_id:1},{text:"CONTROLS 3",values:["JKIUO"],selection:0,ctrl_id:2},{text:"CONTROLS 4",values:["ARROWSPACE"],selection:0,ctrl_id:3},{text:"MAP",values:["RANDOM","BLOODY HALL","DEEP DUNGEON","PILLARS OF CLASH","GOLDHAND","4 COLORS","WINDOW SHOPPERS","UP AND DOWN","CORRIDOR"],selection:0,on_change:function(a){game.TitleScreen.map_selected=a.selection}},{text:"MUSIC VOL",values:["OFF","ON"],selection:1,on_change:function(a){a.selection?(game.music_volume=.3,me.audio.playTrack("menu",game.music_volume)):(game.music_volume=0,me.audio.stopTrack())}}]),game.TitleScreen.selected_setting=0,a.scale(me.game.viewport.width/a.width,1),me.game.world.addChild(a,1),me.game.world.addChild(new(me.Renderable.extend({init:function(){me.Renderable.prototype.init.apply(this,[0,0,me.game.viewport.width,me.game.viewport.height]),this.font=new me.BitmapFont("32x32_font",32,.6),this.font_head=new me.BitmapFont("32x32_font",32,1),this.scrollertween=new me.Tween(this).to({scrollerpos:-2200},1e4).onComplete(this.scrollover.bind(this)).start(),this.scroller="\t\t\t OH WHAT A SHAME! THE KING OF THE DWARFS HAS DIED!\t\t\t DWARFS OF THE WORLD UNITE AND FIGHT FOR THE CROWN!",this.scrollerpos=600},scrollover:function(){this.scrollerpos=640,this.scrollertween.to({scrollerpos:-2200},1e4).onComplete(this.scrollover.bind(this)).start()},update:function(a){return!0},draw:function(a){c="FIGHT OF DWARVES!",x_off=Math.round(this.font_head.measureText(a,c).width/2),this.font_head.draw(a,c,320-x_off,30),this.font.draw(a,this.scroller,this.scrollerpos,440),init_y=100;for(var b=0;b<game.TitleScreen.settings.length;b++){setting=game.TitleScreen.settings[b];var c=setting.text;game.TitleScreen.selected_setting==b&&(c=">"+c+"<"),this.font.draw(a,c,20,init_y+40*b),setting.values.length>0&&this.font.draw(a,setting.values[setting.selection],300,init_y+40*b)}},onDestroyEvent:function(){this.scrollertween.stop()}})),2),me.input.bindKey(me.input.KEY.ENTER,"enter",!0),me.input.bindKey(me.input.KEY.DOWN,"down",!0),me.input.bindKey(me.input.KEY.LEFT,"left",!0),me.input.bindKey(me.input.KEY.RIGHT,"right",!0),me.input.bindKey(me.input.KEY.UP,"up",!0),this.log_controls=-1,this.log_controls_state=-1,this.log_controls_str="",this.handler=me.event.subscribe(me.event.KEYDOWN,function(a,b,c){if(this.log_controls>-1)game.TitleScreen.controls[this.log_controls][this.log_controls_state]=b,this.log_controls_state++,this.log_controls_str=this.log_controls_str+String.fromCharCode(b),1==this.log_controls_state&&(game.TitleScreen.settings[game.TitleScreen.selected_setting].values[0]="RIGHT"),2==this.log_controls_state&&(game.TitleScreen.settings[game.TitleScreen.selected_setting].values[0]="JUMP"),3==this.log_controls_state&&(game.TitleScreen.settings[game.TitleScreen.selected_setting].values[0]="ATTACK"),4==this.log_controls_state&&(game.TitleScreen.settings[game.TitleScreen.selected_setting].values[0]="BLOCK"),this.log_controls_state>4&&(this.log_controls=-1,this.log_controls_state=-1,game.TitleScreen.settings[game.TitleScreen.selected_setting].values[0]=this.log_controls_str);else{if("enter"===a){0==game.TitleScreen.selected_setting&&(me.audio.stopTrack(),game.music_volume>0&&me.audio.playTrack("03 Ferrous Rage",game.music_volume),me.state.change(me.state.PLAY));var d=game.TitleScreen.settings[game.TitleScreen.selected_setting];1==d.values.length&&(this.log_controls=d.ctrl_id,this.log_controls_state=0,this.log_controls_str="",d.values[0]="LEFT")}if("down"===a&&(game.TitleScreen.selected_setting=++game.TitleScreen.selected_setting%game.TitleScreen.settings.length),"up"===a&&(game.TitleScreen.selected_setting--,game.TitleScreen.selected_setting<0&&(game.TitleScreen.selected_setting=game.TitleScreen.settings.length-1),game.TitleScreen.selected_setting=game.TitleScreen.selected_setting%game.TitleScreen.settings.length),"left"===a){var d=game.TitleScreen.settings[game.TitleScreen.selected_setting];d.values.length>1&&(d.selection--,d.selection<0&&(d.selection=d.values.length-1),d.selection=d.selection%d.values.length,"function"==typeof d.on_change&&d.on_change(d))}if("right"===a||"enter"===a){var d=game.TitleScreen.settings[game.TitleScreen.selected_setting];d.values.length>1&&(d.selection=++d.selection%d.values.length,"function"==typeof d.on_change&&d.on_change(d))}}})},onDestroyEvent:function(){me.event.unsubscribe(this.handler)}});